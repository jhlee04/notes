import os
import win32com.client
import pandas as pd

# ì¶”ì¶œí•  ì…€ ìœ„ì¹˜ ë° ë ˆì´ë¸” ë§¤í•‘
TARGET_CELLS = {
    (1, 2): "ê³¼ì œëª…",
    (2, 2): "ë‹´ë‹¹ì",
    (2, 5): "ê¸°ê°„",
    (3, 2): "ëª©ì ",
    (5, 2): "ë°°ê²½ í•„ìš”ì„±",
    (5, 4): "huddle",
    (7, 2): "í˜„ì¬ ì§€í‘œ",
    (7, 3): "ê°œì„  ì§€í‘œ"
}

def process_single_pptx(filepath, ppt_app):
    """ë‹¨ì¼ PPTX íŒŒì¼ì—ì„œ ìŠ¬ë¼ì´ë“œ 2 í‘œ ë‚´ìš© ì¶”ì¶œ"""
    result = {"íŒŒì¼ëª…": os.path.basename(filepath)}

    try:
        presentation = ppt_app.Presentations.Open(filepath, WithWindow=False)
        slide = presentation.Slides(2)

        table_found = False
        for shape in slide.Shapes:
            if shape.HasTable:
                table = shape.Table
                table_found = True
                for (row, col), label in TARGET_CELLS.items():
                    try:
                        cell = table.Cell(row, col).Shape.TextFrame.TextRange
                        text = " ".join([
                            cell.Paragraphs(i).Text.strip()
                            for i in range(1, cell.Paragraphs().Count + 1)
                        ])
                        result[label] = text.strip()
                    except Exception as e:
                        result[label] = f"(ì˜¤ë¥˜: {e})"
                break

        if not table_found:
            for label in TARGET_CELLS.values():
                result[label] = "(í‘œ ì—†ìŒ)"

        presentation.Close()

    except Exception as e:
        print(f"âŒ Error in {os.path.basename(filepath)}: {e}")
        for label in TARGET_CELLS.values():
            result[label] = f"(íŒŒì¼ ì˜¤ë¥˜: {e})"

    return result

def process_folder_ppts(folder_path, output_excel=True):
    """í´ë” ë‚´ ëª¨ë“  PPTX ì²˜ë¦¬ í›„ DataFrame ë°˜í™˜ ë° ì—‘ì…€ ì €ì¥"""
    ppt_app = win32com.client.Dispatch("PowerPoint.Application")
    ppt_app.Visible = False

    results = []
    for filename in os.listdir(folder_path):
        if filename.endswith(".pptx"):
            filepath = os.path.join(folder_path, filename)
            print(f"ğŸ“‚ Processing: {filename}")
            result = process_single_pptx(filepath, ppt_app)
            results.append(result)

    ppt_app.Quit()

    df = pd.DataFrame(results)

    if output_excel:
        output_path = os.path.join(folder_path, "pptx_ìš”ì•½_ê²°ê³¼.xlsx")
        df.to_excel(output_path, index=False)
        print(f"\nâœ… ê²°ê³¼ ì €ì¥ ì™„ë£Œ: {output_path}")

    return df

# ì˜ˆì‹œ ì‹¤í–‰
if __name__ == "__main__":
    folder = r"C:\path\to\your\pptx_files"
    df = process_folder_ppts(folder)
